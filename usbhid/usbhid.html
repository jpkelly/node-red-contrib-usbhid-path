<script type="text/javascript">
    RED.nodes.registerType("hidconfig-p",{
        category: 'config',
        defaults: {
            vid: {value: '', required: true},
            pid: {value: '', required: true},
            interface: {value: ''},
            path: {value: ''},
            name: {value: ''}
        },
        label: function() {
            return this.name || 'HIDConfig';
        },
        oneditprepare: function() {
            function refreshDevices() {
                $.get('/usbhid/devices')
                    .done(function(data) {
                        var select = $('#usbhid-device-list');
                        select.empty();
                        select.append('<option value="">Select a device...</option>');
                        
                        data.forEach(function(device) {
                            var label = (device.product || 'Unknown Device') + 
                                     ' VID:0x' + device.vendorId.toString(16).padStart(4, '0').toUpperCase() + 
                                     ' PID:0x' + device.productId.toString(16).padStart(4, '0').toUpperCase();
                            if (device.interface !== undefined) {
                                label += ' iface:' + device.interface;
                            }
                            label += ' <' + device.path + '>';
                            
                            var option = $('<option></option>')
                                .attr('value', device.path)
                                .text(label);
                            select.append(option);
                        });
                    })
                    .fail(function() {
                        $('#usbhid-device-list').empty().append('<option value="">Error loading devices</option>');
                    });
            }
            
            $('#usbhid-refresh').click(refreshDevices);
            
            $('#usbhid-use').click(function() {
                var selectedPath = $('#usbhid-device-list').val();
                if (selectedPath) {
                    $('#node-config-input-path').val(selectedPath);
                }
            });
            
            refreshDevices();
        }
    });
</script>

<script type="text/x-red" data-template-name="hidconfig-p">
    <div class="form-row">
        <label for="node-config-input-vid"><i class="fa"></i> VID</label>
        <input type="text" id="node-config-input-vid">
    </div>
    <div class="form-row">
        <label for="node-config-input-pid"><i class="fa"></i> PID</label>
        <input type="text" id="node-config-input-pid">
    </div>
    <div class="form-row">
        <label for="node-config-input-interface"><i class="fa"></i> Interface</label>
        <input type="text" id="node-config-input-interface" placeholder="Optional">
    </div>
    <div class="form-row">
        <label for="node-config-input-path"><i class="fa"></i> Path</label>
        <input type="text" id="node-config-input-path" placeholder="If set, Path overrides VID/PID">
    </div>
    <div class="form-row">
        <label><i class="fa fa-list"></i> Devices</label>
        <select id="usbhid-device-list" style="width:70%"></select>
        <button type="button" class="editor-button" id="usbhid-refresh">Refresh</button>
        <button type="button" class="editor-button" id="usbhid-use">Use</button>
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="hidconfig-p">
    <p>Details of the HID Device connection with path-based device selection support</p>
</script><script type="text/javascript">
    RED.nodes.registerType('gethiddevices-p',{
        category: 'USBHid',
        color: '#dce0d9',
        defaults: {
            name: {value:""}            
        },
        inputs:1,
        outputs:1,
        icon: "usb.png",
        label: function() {
            return this.name||"getHIDdevices";
        }
    });
</script>

<script type="text/x-red" data-template-name="gethiddevices-p">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="gethiddevices-p">
    <p>A simple node that lists the connected HID Devices and returns them as msg.payload, including device paths</p>
</script><script type="text/javascript">
    RED.nodes.registerType('hiddevice-p',{
        category: 'USBHid',
        color: '#dce0d9',
        defaults: {
            connection: {type: 'hidconfig-p', required: true},
            name: {value:""}
        },
        inputs:1,
        outputs:3,
        outputLabels: ["data", "error", "status"],
        icon: "usb.png",
        align: 'right',
        label: function() {
            return this.name||"HIDdevice";
        }
    });
</script>

<script type="text/x-red" data-template-name="hiddevice-p">
    <div class="form-row">
        <label for="node-input-connection"><i class="fa"></i> Connection</label>
        <input type="text" id="node-input-connection">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="hiddevice-p">
    <p>A node that communicates with HID Devices using either path-based or VID/PID selection. Receives BYTE array or Buffer as msg.payload and sends it to the HID Device.</p>
    <h3>Outputs</h3>
    <ol>
        <li>Data output: Received data as msg.payload (Buffer)</li>
        <li>Error output: Error messages when they occur</li>
        <li>Status output: Connection status updates as {status: {fill, shape, text}}</li>
    </ol>
</script>